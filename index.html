<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>

    <!-- Logo / Favicon -->
    <link rel="icon" href="sclclogo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="sclclogo.jpg">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Selection Screen -->
    <div id="loginSelection" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <!-- <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">🗳️</span>
                </div> -->
                <img src="sclclogo.jpg" alt="Voting Logo" class="w-16 h-16 mx-auto mb-4 rounded-full object-cover">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">SCLC Voting System 2025</h1>
                <p class="text-gray-600">Choose your login type</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showLogin('admin')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-4 px-6 rounded-xl transition duration-200 transform hover:scale-105">
                    🔐 Admin Login
                </button>
                <button onclick="showLogin('voter')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition duration-200 transform hover:scale-105">
                    👤 Voter Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="adminLogin" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <!-- <div class="bg-red-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">🔐</span>
                </div> -->
                <img src="sclclogo.jpg" alt="Voting Logo" class="w-16 h-16 mx-auto mb-4 rounded-full object-cover">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Admin Login</h2>
                <p class="text-gray-600">Access administrative panel</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="adminUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    Login as Admin
                </button>
            </form>
            
            <button onclick="showLoginSelection()" class="w-full mt-4 text-gray-600 hover:text-gray-800 font-medium">
                ← Back to Selection
            </button>
        </div>
    </div>

    <!-- Voter Login -->
    <div id="voterLogin" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <!-- <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">👤</span>
                </div> -->
                <img src="sclclogo.jpg" alt="Voting Logo" class="w-16 h-16 mx-auto mb-4 rounded-full object-cover">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Voter Login</h2>
                <p class="text-gray-600">Enter your registered details</p>
            </div>
            
            <form onsubmit="voterLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Voter ID Number</label>
                    <input type="number" id="voterNumber" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="voterName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                    Login as Voter
                </button>
            </form>
            
            <button onclick="showLoginSelection()" class="w-full mt-4 text-gray-600 hover:text-gray-800 font-medium">
                ← Back to Selection
            </button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <!-- <span class="text-2xl">🔐</span> -->
                        <img src="sclclogo.jpg" alt="Voting Logo" class="w-8 h-8 mx-auto mb-2 rounded-full object-cover">
                        <h1 class="ml-3 text-xl font-semibold text-gray-900">SCLC Voting Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="adminNameDisplay"></span></span>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Tabs -->
            <div class="mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showAdminTab('voters')" id="votersTab" class="admin-tab-active py-2 px-1 border-b-2 font-medium text-sm">
                            👥 Manage Voters
                        </button>
                        <button onclick="showAdminTab('candidates')" id="candidatesTab" class="admin-tab py-2 px-1 border-b-2 font-medium text-sm">
                            🏆 Manage Candidates
                        </button>
                        <button onclick="showAdminTab('results')" id="resultsTab" class="admin-tab py-2 px-1 border-b-2 font-medium text-sm">
                            📊 Election Results
                        </button>
                        <button onclick="showAdminTab('monitoring')" id="monitoringTab" class="admin-tab py-2 px-1 border-b-2 font-medium text-sm">
                            📈 Vote Monitoring
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Voters Management -->
            <div id="votersManagement" class="admin-content">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Register New Voter</h3>
                    <form onsubmit="registerVoter(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="newVoterName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <input type="text" id="newVoterAddress" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                Register Voter
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Registered Voters</h3>
                        <div class="flex space-x-4">
                            <div class="relative">
                                <input type="text" id="voterSearch" placeholder="Search voters..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <span class="absolute left-3 top-2.5 text-gray-400">🔍</span>
                            </div>
                            <select id="voterFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="all">All Voters</option>
                                <option value="voted">Has Voted</option>
                                <option value="not-voted">Not Voted</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voter ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voting Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="votersTable" class="bg-white divide-y divide-gray-200">
                                <!-- Voters will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Candidates Management -->
            <div id="candidatesManagement" class="admin-content hidden">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Add New Candidate</h3>
                    <form onsubmit="addCandidate(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="newCandidateName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                            <input type="text" id="newCandidatePosition" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="newCandidateDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition duration-200">
                                Add Candidate
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Candidates List</h3>
                    <div id="candidatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Candidates will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Election Results -->
            <div id="electionResults" class="admin-content hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Election Results</h3>
                    <div id="resultsDisplay">
                        <!-- Results will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Vote Monitoring -->
            <div id="voteMonitoring" class="admin-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <span class="text-blue-600 text-xl">👥</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Voters</p>
                                <p id="totalVoters" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-full">
                                <span class="text-green-600 text-xl">✅</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Votes Cast</p>
                                <p id="votesCast" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <span class="text-yellow-600 text-xl">⏳</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Turnout Rate</p>
                                <p id="turnoutRate" class="text-2xl font-bold text-gray-900">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Votes</h3>
                        <div class="flex space-x-4">
                            <div class="relative">
                                <input type="text" id="voteSearch" placeholder="Search votes..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <span class="absolute left-3 top-2.5 text-gray-400">🔍</span>
                            </div>
                            <select id="voteFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="all">All Votes</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voter ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voter Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vote Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentVotesTable" class="bg-white divide-y divide-gray-200">
                                <!-- Recent votes will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voter Dashboard -->
    <div id="voterDashboard" class="hidden min-h-screen bg-gray-50">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-2xl">🗳️</span>
                        <h1 class="ml-3 text-xl font-semibold text-gray-900">Voter Portal</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Welcome, <span id="voterNameDisplay"></span></span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">ID: <span id="voterIdDisplay"></span></span>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Voter Status -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Voting Status</h3>
                <div id="voterStatus" class="flex items-center space-x-4">
                    <!-- Status will be loaded here -->
                </div>
            </div>

            <!-- Voting Section -->
            <div id="votingSection" class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Cast Your Vote</h3>
                <div id="candidatesVoting">
                    <!-- Candidates for voting will be loaded here -->
                </div>
            </div>

            <!-- Vote History -->
            <div id="voteHistory" class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Vote History</h3>
                <div id="voterVoteHistory">
                    <!-- Vote history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Voter Details Modal -->
    <div id="voterDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900" id="modalVoterName">Voter Details</h3>
                    <button onclick="closeVoterModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                <div id="voterDetailsContent" class="space-y-4">
                    <!-- Voter details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://gemoullkrjsloxjfdfzb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlbW91bGxrcmpzbG94amZkZnpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjgyNTksImV4cCI6MjA3NDMwNDI1OX0.II9RlHAzsfg3mLWk6IlPicZjqao78T_3rmviK2wJwpU';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let userType = null;
        let allVoters = [];
        let allVotes = [];

        // Navigation functions
        function showLoginSelection() {
            hideAllScreens();
            document.getElementById('loginSelection').classList.remove('hidden');
        }

        function showLogin(type) {
            hideAllScreens();
            if (type === 'admin') {
                document.getElementById('adminLogin').classList.remove('hidden');
            } else {
                document.getElementById('voterLogin').classList.remove('hidden');
            }
        }

        function hideAllScreens() {
            const screens = ['loginSelection', 'adminLogin', 'voterLogin', 'adminDashboard', 'voterDashboard'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // Admin login
        async function adminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                // Query admins table with email-based authentication
                const { data, error } = await supabaseClient
                    .from('admins')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (error || !data) {
                    showMessage('Invalid admin credentials', 'error');
                    return;
                }

                // Simple password check (in production, use proper bcrypt hashing)
                if (data.password !== password) {
                    showMessage('Invalid admin credentials', 'error');
                    return;
                }

                currentUser = data;
                userType = 'admin';
                document.getElementById('adminNameDisplay').textContent = data.full_name;
                
                hideAllScreens();
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadAdminData();
                showMessage('Welcome, Admin!', 'success');
            } catch (error) {
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        // Voter login
        async function voterLogin(event) {
            event.preventDefault();
            const voterNumber = document.getElementById('voterNumber').value;
            const voterName = document.getElementById('voterName').value;

            try {
                const { data, error } = await supabaseClient
                    .from('voters')
                    .select('*')
                    .eq('voter_number', voterNumber)
                    .eq('name', voterName)
                    .single();

                if (error || !data) {
                    showMessage('Invalid voter credentials', 'error');
                    return;
                }

                currentUser = data;
                userType = 'voter';
                document.getElementById('voterNameDisplay').textContent = data.name;
                document.getElementById('voterIdDisplay').textContent = data.voter_number;
                
                hideAllScreens();
                document.getElementById('voterDashboard').classList.remove('hidden');
                loadVoterData();
                showMessage('Welcome, ' + data.name + '!', 'success');
            } catch (error) {
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            userType = null;
            showLoginSelection();
            showMessage('Logged out successfully', 'success');
        }

        // Admin tab navigation
        function showAdminTab(tabName) {
            // Update tab styles
            document.querySelectorAll('.admin-tab, .admin-tab-active').forEach(tab => {
                tab.className = 'admin-tab py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm';
            });
            document.getElementById(tabName + 'Tab').className = 'admin-tab-active py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm';

            // Show/hide content
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.add('hidden');
            });

            const contentMap = {
                'voters': 'votersManagement',
                'candidates': 'candidatesManagement',
                'results': 'electionResults',
                'monitoring': 'voteMonitoring'
            };

            document.getElementById(contentMap[tabName]).classList.remove('hidden');

            // Load specific data
            if (tabName === 'results') loadElectionResults();
            if (tabName === 'monitoring') loadVoteMonitoring();
        }

        // Register new voter
        async function registerVoter(event) {
            event.preventDefault();
            
            try {
                // Create voter data with updated schema
                const voterData = {
                    name: document.getElementById('newVoterName').value,
                    address: document.getElementById('newVoterAddress').value
                };

                // Insert directly into voters table
                const { data, error } = await supabaseClient
                    .from('voters')
                    .insert([voterData])
                    .select('voter_number')
                    .single();

                if (error) throw error;

                showMessage('Voter registered successfully! Voter ID: ' + data.voter_number, 'success');
                event.target.reset();
                loadVoters();
                
            } catch (error) {
                showMessage('Registration failed: ' + error.message, 'error');
                console.error('Registration error details:', error);
            }
        }

        // Add new candidate
        async function addCandidate(event) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('newCandidateName').value,
                position: document.getElementById('newCandidatePosition').value,
                description: document.getElementById('newCandidateDescription').value
            };

            try {
                const { data, error } = await supabaseClient
                    .from('candidates')
                    .insert([formData]);

                if (error) throw error;

                showMessage('Candidate added successfully!', 'success');
                event.target.reset();
                loadCandidates();
            } catch (error) {
                showMessage('Failed to add candidate: ' + error.message, 'error');
            }
        }

        // Cast vote
        async function castVote(candidateId, position) {
            try {
                // Check if voter has already voted for this specific position
                const { data: existingVotes, error: checkError } = await supabaseClient
                    .from('votes')
                    .select(`
                        vote_id,
                        candidates (position)
                    `)
                    .eq('voter_id', currentUser.voter_id);

                if (checkError) throw checkError;

                // Check if already voted for this position
                const hasVotedForPosition = existingVotes.some(vote => 
                    vote.candidates && vote.candidates.position === position
                );

                if (hasVotedForPosition) {
                    showMessage(`You have already voted for ${position}!`, 'error');
                    return;
                }

                // Insert vote with updated schema
                const { error: voteError } = await supabaseClient
                    .from('votes')
                    .insert([{
                        voter_id: currentUser.voter_id,
                        candidate_id: candidateId
                    }]);

                if (voteError) throw voteError;

                showMessage(`Vote cast successfully for ${position}!`, 'success');
                loadVoterData();
            } catch (error) {
                showMessage('Failed to cast vote: ' + error.message, 'error');
                console.error('Vote casting error:', error);
            }
        }

        // Load admin data
        async function loadAdminData() {
            loadVoters();
            loadCandidates();
        }

        // Load voters
        async function loadVoters() {
            try {
                // Get voters with their vote counts
                const { data: votersData, error: votersError } = await supabaseClient
                    .from('voters')
                    .select('*')
                    .order('voter_number');

                if (votersError) throw votersError;

                // Get vote counts for each voter
                const { data: votesData, error: votesError } = await supabaseClient
                    .from('votes')
                    .select('voter_id');

                if (votesError) throw votesError;

                // Create vote count map
                const voteCountMap = {};
                votesData.forEach(vote => {
                    voteCountMap[vote.voter_id] = (voteCountMap[vote.voter_id] || 0) + 1;
                });

                // Add vote status to voters
                allVoters = votersData.map(voter => ({
                    ...voter,
                    voteCount: voteCountMap[voter.voter_id] || 0,
                    hasVoted: (voteCountMap[voter.voter_id] || 0) > 0
                }));

                displayVoters(allVoters);
                setupVoterSearch();
            } catch (error) {
                showMessage('Failed to load voters: ' + error.message, 'error');
            }
        }

        // Display voters in table
        function displayVoters(voters) {
            const tbody = document.getElementById('votersTable');
            tbody.innerHTML = voters.map(voter => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${voter.voter_number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.address || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(voter.created_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${voter.hasVoted ? 
                            `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Voted (${voter.voteCount})
                            </span>` :
                            `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                Not Voted
                            </span>`
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewVoterDetails('${voter.voter_id}')" class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded-lg transition duration-200">
                            View Votes
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Setup voter search and filter
        function setupVoterSearch() {
            const searchInput = document.getElementById('voterSearch');
            const filterSelect = document.getElementById('voterFilter');

            function filterVoters() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = filterSelect.value;

                let filteredVoters = allVoters.filter(voter => {
                    const matchesSearch = voter.name.toLowerCase().includes(searchTerm) ||
                                        voter.voter_number.toString().includes(searchTerm) ||
                                        (voter.address && voter.address.toLowerCase().includes(searchTerm));

                    const matchesFilter = filterValue === 'all' ||
                                        (filterValue === 'voted' && voter.hasVoted) ||
                                        (filterValue === 'not-voted' && !voter.hasVoted);

                    return matchesSearch && matchesFilter;
                });

                displayVoters(filteredVoters);
            }

            searchInput.addEventListener('input', filterVoters);
            filterSelect.addEventListener('change', filterVoters);
        }

        // Load candidates
        async function loadCandidates() {
            try {
                const { data, error } = await supabaseClient
                    .from('candidates')
                    .select('*')
                    .order('position');

                if (error) throw error;

                const container = document.getElementById('candidatesList');
                container.innerHTML = data.map(candidate => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900">${candidate.name}</h4>
                        <p class="text-sm text-blue-600 font-medium">${candidate.position}</p>
                        <p class="text-sm text-gray-600 mt-2">${candidate.description || 'No description'}</p>
                    </div>
                `).join('');
            } catch (error) {
                showMessage('Failed to load candidates: ' + error.message, 'error');
            }
        }

        // Load election results
        async function loadElectionResults() {
            try {
                const { data, error } = await supabaseClient
                    .from('election_results')
                    .select('*');

                if (error) throw error;

                // Group by position
                const positions = {};
                data.forEach(result => {
                    if (!positions[result.position]) {
                        positions[result.position] = [];
                    }
                    positions[result.position].push(result);
                });

                const container = document.getElementById('resultsDisplay');
                container.innerHTML = Object.keys(positions).map(position => {
                    const candidates = positions[position];
                    const winner = candidates[0];
                    const totalVotes = candidates.reduce((sum, c) => sum + c.total_votes, 0);

                    return `
                        <div class="mb-8">
                            <h4 class="text-xl font-bold text-gray-900 mb-4">${position}</h4>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">🏆</span>
                                    <div>
                                        <p class="font-semibold text-green-800">Winner: ${winner.candidate_name}</p>
                                        <p class="text-sm text-green-600">${winner.total_votes} votes (${totalVotes > 0 ? Math.round((winner.total_votes / totalVotes) * 100) : 0}%)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                ${candidates.map(candidate => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span class="font-medium">${candidate.candidate_name}</span>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-600">${candidate.total_votes} votes</span>
                                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${totalVotes > 0 ? (candidate.total_votes / totalVotes) * 100 : 0}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showMessage('Failed to load results: ' + error.message, 'error');
            }
        }

        // Load vote monitoring
        async function loadVoteMonitoring() {
            try {
                // Get total voters
                const { data: votersData, error: votersError } = await supabaseClient
                    .from('voters')
                    .select('voter_id');

                if (votersError) throw votersError;

                // Get total votes cast
                const { data: votesData, error: votesCountError } = await supabaseClient
                    .from('votes')
                    .select('vote_id');

                if (votesCountError) throw votesCountError;

                const totalVoters = votersData.length;
                const votedCount = votesData.length;
                const turnoutRate = totalVoters > 0 ? Math.round((votedCount / totalVoters) * 100) : 0;

                document.getElementById('totalVoters').textContent = totalVoters;
                document.getElementById('votesCast').textContent = votedCount;
                document.getElementById('turnoutRate').textContent = turnoutRate + '%';

                // Get all votes with details
                const { data: allVotesData, error: votesError } = await supabaseClient
                    .from('votes')
                    .select(`
                        *,
                        voters (voter_number, name),
                        candidates (name, position)
                    `)
                    .order('voted_at', { ascending: false });

                if (votesError) throw votesError;

                allVotes = allVotesData;
                displayVotes(allVotes);
                setupVoteSearch();
            } catch (error) {
                showMessage('Failed to load monitoring data: ' + error.message, 'error');
            }
        }

        // Display votes in table
        function displayVotes(votes) {
            const tbody = document.getElementById('recentVotesTable');
            tbody.innerHTML = votes.map(vote => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${vote.voters.voter_number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${vote.voters.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(vote.voted_at).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Completed
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Setup vote search and filter
        function setupVoteSearch() {
            const searchInput = document.getElementById('voteSearch');
            const filterSelect = document.getElementById('voteFilter');

            function filterVotes() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = filterSelect.value;

                let filteredVotes = allVotes.filter(vote => {
                    const matchesSearch = vote.voters.name.toLowerCase().includes(searchTerm) ||
                                        vote.voters.voter_number.toString().includes(searchTerm) ||
                                        (vote.candidates.name && vote.candidates.name.toLowerCase().includes(searchTerm)) ||
                                        (vote.candidates.position && vote.candidates.position.toLowerCase().includes(searchTerm));

                    let matchesFilter = true;
                    if (filterValue !== 'all') {
                        const voteDate = new Date(vote.voted_at);
                        const now = new Date();
                        
                        if (filterValue === 'today') {
                            matchesFilter = voteDate.toDateString() === now.toDateString();
                        } else if (filterValue === 'week') {
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesFilter = voteDate >= weekAgo;
                        } else if (filterValue === 'month') {
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            matchesFilter = voteDate >= monthAgo;
                        }
                    }

                    return matchesSearch && matchesFilter;
                });

                displayVotes(filteredVotes);
            }

            searchInput.addEventListener('input', filterVotes);
            filterSelect.addEventListener('change', filterVotes);
        }

        // Load voter data
        async function loadVoterData() {
            loadVoterStatus();
            loadVotingCandidates();
            loadVoterHistory();
        }

        // Load voter status
        async function loadVoterStatus() {
            try {
                // Get all available positions
                const { data: allCandidates, error: candidatesError } = await supabaseClient
                    .from('candidates')
                    .select('position');

                if (candidatesError) throw candidatesError;

                const allPositions = [...new Set(allCandidates.map(c => c.position))];

                // Check which positions voter has voted for
                const { data: existingVotes, error } = await supabaseClient
                    .from('votes')
                    .select(`
                        vote_id,
                        candidates (position)
                    `)
                    .eq('voter_id', currentUser.voter_id);

                if (error) throw error;

                const votedPositions = existingVotes.map(vote => vote.candidates.position);
                const remainingPositions = allPositions.filter(pos => !votedPositions.includes(pos));
                
                const statusContainer = document.getElementById('voterStatus');
                
                if (remainingPositions.length === 0) {
                    statusContainer.innerHTML = `
                        <div class="flex items-center text-green-600">
                            <span class="text-2xl mr-3">✅</span>
                            <div>
                                <p class="font-semibold">All Votes Submitted</p>
                                <p class="text-sm">You have voted for all ${allPositions.length} positions. Thank you for participating!</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusContainer.innerHTML = `
                        <div class="flex items-center text-blue-600">
                            <span class="text-2xl mr-3">🗳️</span>
                            <div>
                                <p class="font-semibold">Voting Progress: ${votedPositions.length}/${allPositions.length}</p>
                                <p class="text-sm">You can still vote for: ${remainingPositions.join(', ')}</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error checking voter status:', error);
            }
        }

        // Load voting candidates
        async function loadVotingCandidates() {
            try {
                // Get all candidates
                const { data, error } = await supabaseClient
                    .from('candidates')
                    .select('*')
                    .order('position');

                if (error) throw error;

                // Get voter's existing votes
                const { data: existingVotes, error: checkError } = await supabaseClient
                    .from('votes')
                    .select(`
                        vote_id,
                        candidates (position, name)
                    `)
                    .eq('voter_id', currentUser.voter_id);

                if (checkError) throw checkError;

                const votedPositions = existingVotes.map(vote => vote.candidates.position);

                // Group by position
                const positions = {};
                data.forEach(candidate => {
                    if (!positions[candidate.position]) {
                        positions[candidate.position] = [];
                    }
                    positions[candidate.position].push(candidate);
                });

                const container = document.getElementById('candidatesVoting');
                container.innerHTML = Object.keys(positions).map(position => {
                    const hasVotedForPosition = votedPositions.includes(position);
                    const votedCandidate = hasVotedForPosition ? 
                        existingVotes.find(vote => vote.candidates.position === position)?.candidates.name : null;

                    if (hasVotedForPosition) {
                        return `
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Vote for ${position}</h4>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">✅</span>
                                        <div>
                                            <p class="font-semibold text-green-800">Vote Cast</p>
                                            <p class="text-sm text-green-600">You voted for: ${votedCandidate}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Vote for ${position}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${positions[position].map(candidate => `
                                    <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition duration-200">
                                        <h5 class="font-semibold text-gray-900">${candidate.name}</h5>
                                        <p class="text-sm text-gray-600 mt-1">${candidate.description || 'No description'}</p>
                                        <button onclick="castVote('${candidate.candidate_id}', '${position}')" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                            Vote for ${candidate.name}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showMessage('Failed to load candidates: ' + error.message, 'error');
            }
        }

        // Load voter history
        async function loadVoterHistory() {
            try {
                const { data, error } = await supabaseClient
                    .from('votes')
                    .select(`
                        *,
                        candidates (name, position)
                    `)
                    .eq('voter_id', currentUser.voter_id)
                    .order('voted_at', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('voterVoteHistory');
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="text-4xl">📝</span>
                            <p class="mt-2">No votes cast yet</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="space-y-3">
                            ${data.map(vote => `
                                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-900">${vote.candidates.name}</p>
                                        <p class="text-sm text-gray-600">${vote.candidates.position}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">${new Date(vote.voted_at).toLocaleDateString()}</p>
                                        <p class="text-xs text-gray-400">${new Date(vote.voted_at).toLocaleTimeString()}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                showMessage('Failed to load vote history: ' + error.message, 'error');
            }
        }

        // View voter details
        async function viewVoterDetails(voterId) {
            try {
                // Get voter info
                const voter = allVoters.find(v => v.voter_id === voterId);
                if (!voter) {
                    showMessage('Voter not found', 'error');
                    return;
                }

                // Get voter's votes
                const { data: voterVotes, error } = await supabaseClient
                    .from('votes')
                    .select(`
                        *,
                        candidates (name, position)
                    `)
                    .eq('voter_id', voterId)
                    .order('voted_at', { ascending: false });

                if (error) throw error;

                // Update modal content
                document.getElementById('modalVoterName').textContent = `${voter.name} (ID: ${voter.voter_number})`;
                
                const content = document.getElementById('voterDetailsContent');
                if (voterVotes.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="text-4xl">📝</span>
                            <p class="mt-2">This voter has not cast any votes yet</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-900 mb-2">Voter Information</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p><strong>Name:</strong> ${voter.name}</p>
                                <p><strong>Voter ID:</strong> ${voter.voter_number}</p>
                                <p><strong>Address:</strong> ${voter.address || 'N/A'}</p>
                                <p><strong>Registration Date:</strong> ${new Date(voter.created_at).toLocaleDateString()}</p>
                                <p><strong>Total Votes Cast:</strong> ${voterVotes.length}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Vote History</h4>
                            <div class="space-y-3">
                                ${voterVotes.map(vote => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium text-gray-900">${vote.candidates.name}</p>
                                            <p class="text-sm text-gray-600">${vote.candidates.position}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-500">${new Date(vote.voted_at).toLocaleDateString()}</p>
                                            <p class="text-xs text-gray-400">${new Date(vote.voted_at).toLocaleTimeString()}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Show modal
                document.getElementById('voterDetailsModal').classList.remove('hidden');
            } catch (error) {
                showMessage('Failed to load voter details: ' + error.message, 'error');
            }
        }

        // Close voter modal
        function closeVoterModal() {
            document.getElementById('voterDetailsModal').classList.add('hidden');
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
                'bg-red-100 border border-red-400 text-red-700'
            }`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showLoginSelection();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984610dbb5ddfed0',t:'MTc1ODc1NjU4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
